# app/main.py の初心者向け解説

## 概要

`app/main.py` は、Bluetooth AVRCP メタデータをリアルタイムに収集・記録する FastAPI Web アプリケーションの本体。

## ファイル構成

1. **インポートと定数定義** (1-41行): FastAPI, SSE, AVRCP モニターなどのインポートと、OS選択肢の定義
2. **SessionState データクラス** (44-55行): セッション状態（録音中か、曲名、トラック一覧など）を管理
3. **グローバル変数** (59-65行): セッション状態、SSEキュー、AVRCP モニターの参照
4. **メタデータ受信コールバック** (68-104行): Bluetooth から曲情報を受け取り、セッションに記録しつつ SSE で配信
5. **lifespan（起動/終了処理）** (107-123行): AVRCP モニターの開始・停止
6. **ページ表示エンドポイント** (133-145行): メインページの表示
7. **セッション管理 API** (151-240行): 録音の開始・停止・状態取得
8. **OS 選択肢 API** (246-254行): 端末に応じた OS バージョンの動的取得
9. **SSE リアルタイム配信** (260-298行): ブラウザへのリアルタイムメタデータ配信
10. **ヘルパー関数** (301-376行): 再生時間のフォーマットとトラックカード HTML 生成
11. **過去セッション管理** (382-405行): 一覧取得とファイルダウンロード
12. **ヘルスチェック** (411-418行): アプリの稼働状態確認

## データフロー

```
Bluetooth デバイス → AVRCPMonitor (別スレッド) → _on_metadata → _handle_metadata → SSE キュー → ブラウザ
                                                                  ↓
                                                          session.tracks に蓄積
                                                                  ↓ (停止時)
                                                          ファイルに保存
```

## 技術的ポイント

- **スレッド安全性**: Bluetooth 監視は別スレッドで動くため、`call_soon_threadsafe` で asyncio スレッドへ安全にデータを渡している
- **SSE**: Server-Sent Events でブラウザにリアルタイム配信。30秒の ping でコネクション維持
- **htmx 連携**: HTML の部分テンプレート（partials/）を返すことで、ページ全体をリロードせずに UI を更新
