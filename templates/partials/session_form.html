<form hx-post="/session/start" hx-target="#session-control" hx-swap="innerHTML" class="session-form">
    <div class="form-group">
        <label for="content_name">コンテンツ名</label>
        <select id="content_name" name="content_name" required>
            <option value="">-- 選択 --</option>
            {% for category, services in content_options.items() %}
            <optgroup label="{{ category }}">
                {% for service in services %}
                <option value="{{ service }}">{{ service }}</option>
                {% endfor %}
            </optgroup>
            {% endfor %}
            <option value="その他">その他（自由入力）</option>
        </select>
        <input type="text" id="content-custom" name="content_name_custom"
               placeholder="コンテンツ名を入力"
               class="hidden" disabled>
    </div>

    <div class="form-group">
        <label for="platform_type">Web or アプリ</label>
        <select id="platform_type" name="platform_type" required>
            <option value="">-- 選択 --</option>
            <option value="web">Web</option>
            <option value="app">アプリ</option>
        </select>
    </div>

    <div class="form-group">
        <label for="device">コンテンツ再生端末</label>
        <select id="device" name="device" required
                hx-get="/os-options"
                hx-target="#os-select"
                hx-swap="innerHTML"
                hx-include="this">
            <option value="">-- 選択 --</option>
            <option value="iPhone">iPhone</option>
            <option value="Mac">Mac</option>
            <option value="Windows">Windows</option>
            <option value="Android">Android</option>
        </select>
    </div>

    <div class="form-group">
        <label for="os_version">コンテンツ再生 OS</label>
        <select id="os-select" name="os_version" required>
            <option value="">-- 端末を先に選択 --</option>
        </select>
        <input type="text" id="os-custom" name="os_version_custom"
               placeholder="OS バージョンを入力"
               class="hidden" disabled>
    </div>

    <div class="form-group">
        <label class="checkbox-label">
            <input type="checkbox" id="bg_playback" name="bg_playback">
            BG再生（バックグラウンド再生中）
        </label>
    </div>

    <button type="submit" class="btn btn-start">セッション開始</button>
</form>

<script>
document.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail && evt.detail.target && evt.detail.target.id === 'os-select') {
        const select = document.getElementById('os-select');
        const customInput = document.getElementById('os-custom');
        if (select && customInput) {
            select.addEventListener('change', function() {
                if (this.value === 'その他') {
                    customInput.classList.remove('hidden');
                    customInput.disabled = false;
                    customInput.required = true;
                    select.name = '';
                    customInput.name = 'os_version';
                } else {
                    customInput.classList.add('hidden');
                    customInput.disabled = true;
                    customInput.required = false;
                    select.name = 'os_version';
                    customInput.name = 'os_version_custom';
                }
            });
        }
    }
});

// コンテンツ名の「その他」選択時に自由入力
(function() {
    const select = document.getElementById('content_name');
    const customInput = document.getElementById('content-custom');
    if (select && customInput) {
        select.addEventListener('change', function() {
            if (this.value === 'その他') {
                customInput.classList.remove('hidden');
                customInput.disabled = false;
                customInput.required = true;
                select.name = '';
                customInput.name = 'content_name';
            } else {
                customInput.classList.add('hidden');
                customInput.disabled = true;
                customInput.required = false;
                select.name = 'content_name';
                customInput.name = 'content_name_custom';
            }
        });
    }
})();
</script>
